<!DOCTYPE html>
<html>
   <head>
      <title>MoviePhone</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
      <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/styles.css') }}">
      <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Slab&display=swap" rel="stylesheet">
   </head>
   <body>
     <header>
      <div class="collapse bg-dark" id="navbarHeader">
        <div class="container">
          <div class="row">
            <div class="col-sm-8 col-md-7 py-4">
              <h4 class="text-white">About</h4>
              <p class="text-muted">MoviePhone helps by making your movie viewing experience as seamless as possible!</p>
            </div>
            <div class="col-sm-4 offset-md-1 py-4">
              <h4 class="text-white">Contact</h4>
              <ul class="list-unstyled">
                <li><a href="#" class="text-white">Email me at: zachspielberger@gmail.com</a></li>
                <li><a href="#" class="text-white">View <a href="https://github.com/zachspiel" target="_blank">Github</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="navbar navbar-dark bg-dark box-shadow">
        <div class="container d-flex justify-content-between">
          <a href="{{ url_for('index' )}}" class="navbar-brand d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            <strong class="logo">MoviePhone</strong>
          </a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
      </div>
    </header>

    <main>
       <section class="jumbotron text-center" style="background-color: #fff;">
        <div class="container">
          <h1 class="jumbotron-heading">MoviePhone</h1>
          <p class="lead text-muted">MoviePhone retrieves all of the latest movies and showtimes as soon as they are added to Harkins and AMC so you can find all showtimes in one place. Future updates will include other movie chains.</p>
          <p>
            <a href="{{ url_for('search') }}" class="btn btn-primary my-2">Search for movies now</a>
          </p>
        </div>
      </section>
    </main>

    <div class="container-fluid">
      <div class="row justify-content-center align-items-center">
        <div class="col-md-4 col-sm-12">
          <h1>Movie theaters near you</h1>
        </div>
        <div class="col-md-8 col-sm-12">
          <div style="height:900px; width:900px;">
             <div id="map-canvas">
               <div id="panel"></div>
               <div id="map"></div>
             </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      /* Note: This example requires that you consent to location sharing when
       * prompted by your browser. If you see the error "Geolocation permission
       * denied.", it means you probably did not give permission for the browser * to locate you. */
      let pos;
      let map;
      let bounds;
      let infoWindow;
      let currentInfoWindow;
      let service;
      let infoPane;
      function initMap() {
        // Initialize variables
        bounds = new google.maps.LatLngBounds();
        infoWindow = new google.maps.InfoWindow;
        currentInfoWindow = infoWindow;
        /* TODO: Step 4A3: Add a generic sidebar */
        infoPane = document.getElementById('panel');

        // Try HTML5 geolocation
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(position => {
            pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            map = new google.maps.Map(document.getElementById('map'), {
              center: pos,
              zoom: 15
            });
            bounds.extend(pos);

            infoWindow.setPosition(pos);
            infoWindow.setContent('Location found.');
            infoWindow.open(map);
            map.setCenter(pos);

            // Call Places Nearby Search on user's location
            getNearbyPlaces(pos);
          }, () => {
            // Browser supports geolocation, but user has denied permission
            handleLocationError(true, infoWindow);
          });
        } else {
          // Browser doesn't support geolocation
          handleLocationError(false, infoWindow);
        }
      }

      // Handle a geolocation error
      function handleLocationError(browserHasGeolocation, infoWindow) {
        // Set default location to Sydney, Australia
        pos = { lat: -33.856, lng: 151.215 };
        map = new google.maps.Map(document.getElementById('map'), {
          center: pos,
          zoom: 15
        });

        // Display an InfoWindow at the map center
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
          'Geolocation permissions denied. Using default location.' :
          'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
        currentInfoWindow = infoWindow;

        // Call Places Nearby Search on the default location
        getNearbyPlaces(pos);
      }

      // Perform a Places Nearby Search Request
      function getNearbyPlaces(position) {
        let request = {
          location: position,
          rankBy: google.maps.places.RankBy.DISTANCE,
          keyword: 'harkins,amc'
        };

        service = new google.maps.places.PlacesService(map);
        service.nearbySearch(request, nearbyCallback);
      }

      // Handle the results (up to 20) of the Nearby Search
      function nearbyCallback(results, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {
          createMarkers(results);
        }
      }

      // Set markers at the location of each place result
      function createMarkers(places) {
        places.forEach(place => {
          let marker = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            title: place.name
          });

          /* TODO: Step 4B: Add click listeners to the markers */
          // Add click listener to each marker
          google.maps.event.addListener(marker, 'click', () => {
            let request = {
              placeId: place.place_id,
              fields: ['name', 'formatted_address', 'geometry', 'rating',
                'website', 'photos']
            };

            /* Only fetch the details of a place when the user clicks on a marker.
             * If we fetch the details for all place results as soon as we get
             * the search response, we will hit API rate limits. */
            service.getDetails(request, (placeResult, status) => {
              showDetails(placeResult, marker, status)
            });
          });

          // Adjust the map bounds to include the location of this marker
          bounds.extend(place.geometry.location);
        });
        /* Once all the markers have been placed, adjust the bounds of the map to
         * show all the markers within the visible area. */
        map.fitBounds(bounds);
      }

      /* TODO: Step 4C: Show place details in an info window */
      // Builds an InfoWindow to display details above the marker
      function showDetails(placeResult, marker, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {
          let placeInfowindow = new google.maps.InfoWindow();
          let rating = "None";
          if (placeResult.rating) rating = placeResult.rating;
          placeInfowindow.setContent('<div><strong>' + placeResult.name +
            '</strong><br>' + 'Rating: ' + rating + '</div>');
          placeInfowindow.open(marker.map, marker);
          currentInfoWindow.close();
          currentInfoWindow = placeInfowindow;
          showPanel(placeResult);
        } else {
          console.log('showDetails failed: ' + status);
        }
      }

      /* TODO: Step 4D: Load place details in a sidebar */
      // Displays place details in a sidebar
      function showPanel(placeResult) {
        // If infoPane is already open, close it
        if (infoPane.classList.contains("open")) {
          infoPane.classList.remove("open");
        }

        // Clear the previous details
        while (infoPane.lastChild) {
          infoPane.removeChild(infoPane.lastChild);
        }

        /* TODO: Step 4E: Display a Place Photo with the Place Details */
        // Add the primary photo, if there is one
        if (placeResult.photos) {
          let firstPhoto = placeResult.photos[0];
          let photo = document.createElement('img');
          photo.classList.add('hero');
          photo.src = firstPhoto.getUrl();
          infoPane.appendChild(photo);
        }

        // Add place details with text formatting
        let name = document.createElement('h1');
        name.classList.add('place');
        name.textContent = placeResult.name;
        infoPane.appendChild(name);
        if (placeResult.rating) {
          let rating = document.createElement('p');
          rating.classList.add('details');
          rating.textContent = `Rating: ${placeResult.rating} \u272e`;
          infoPane.appendChild(rating);
        }
        let address = document.createElement('p');
        address.classList.add('details');
        address.textContent = placeResult.formatted_address;
        infoPane.appendChild(address);
        if (placeResult.website) {
          let websitePara = document.createElement('p');
          let websiteLink = document.createElement('a');
          let websiteUrl = document.createTextNode(placeResult.website);
          websiteLink.appendChild(websiteUrl);
          websiteLink.title = placeResult.website;
          websiteLink.href = placeResult.website;
          websitePara.appendChild(websiteLink);
          infoPane.appendChild(websitePara);
        }

        // Open the infoPane
        infoPane.classList.add("open");
      }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAlvLs2DDai1h1LlAMmjnZGJsHDQRMb3U&libraries=places&callback=initMap">
</script>
      <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
   </body>
</html>
